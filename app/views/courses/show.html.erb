<div class="bg-dark text-white py-5 mb-5">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-8">
        <span class="badge bg-warning text-dark mb-2">
          <%= @course.category&.name || "General" %>
        </span>

        <h1 class="display-4 fw-bold"><%= @course.title %></h1>
        <p class="lead"><%= @course.description %></p>

        <div class="mt-4">
          <% if current_user %>
            <%# --- TRƯỜNG HỢP 1: ĐÃ ĐĂNG NHẬP --- %>

            <% if current_user.enrolled_in?(@course) %>
              <%# A. Đã có bản ghi đăng ký -> Kiểm tra trạng thái %>

              <% enrollment = current_user.enrollments.find_by(course: @course) %>

              <% if enrollment.active? %>
                 <%# A1. Đã Active -> Vào học %>
                 <% first_lesson = @course.course_modules.first&.lessons&.first %>
                 <% if first_lesson %>
                   <%= link_to lesson_path(first_lesson), class: "btn btn-success btn-lg px-4 me-2 shadow" do %>
                     <i class="bi bi-play-circle-fill"></i> Vào học ngay
                   <% end %>
                 <% else %>
                   <button class="btn btn-secondary btn-lg px-4 me-2" disabled>Nội dung đang cập nhật</button>
                 <% end %>

              <% elsif enrollment.pending? %>
                 <%# A2. Đang chờ duyệt %>
                 <button class="btn btn-warning btn-lg px-4 me-2 disabled text-dark fw-bold">
                   <i class="bi bi-clock-history"></i> Đang chờ duyệt thanh toán
                 </button>
                 <p class="text-white-50 mt-2 small">
                   <i class="bi bi-info-circle"></i> Admin đang kiểm tra giao dịch. Vui lòng quay lại sau.
                 </p>

              <% else %>
                 <%# A3. Bị từ chối %>
                 <button class="btn btn-danger disabled">Yêu cầu bị từ chối</button>
                 <p class="text-white-50 mt-2 small">Vui lòng liên hệ Admin để biết chi tiết.</p>
              <% end %>

            <% else %>
              <%# B. Chưa đăng ký -> Hiển thị nút Đăng ký/Mua %>

              <% if @course.free? %>
                <%# B1. Khóa học Miễn phí %>
                <%= button_to course_enrollments_path(@course), method: :post, class: "btn btn-primary btn-lg px-4 shadow" do %>
                  <i class="bi bi-person-plus-fill"></i> Đăng ký học miễn phí
                <% end %>
              <% else %>
                <%# B2. Khóa học Trả phí %>
                <div class="d-flex align-items-center flex-wrap">
                  <h2 class="text-warning me-4 mb-0 fw-bold">
                    <%= number_to_currency(@course.price, unit: "₫", format: "%n %u", precision: 0) %>
                  </h2>

                  <%= button_to course_enrollments_path(@course),
                        method: :post,
                        class: "btn btn-primary btn-lg px-4 shadow",
                        data: { confirm: "Xác nhận gửi yêu cầu đăng ký khóa học này?" } do %>
                    <i class="bi bi-cart-check-fill"></i> Đăng ký mua ngay
                  <% end %>
                </div>
                <p class="text-white-50 mt-2 small">
                  * Sau khi đăng ký, vui lòng chuyển khoản để Admin kích hoạt khóa học.
                </p>
              <% end %>

            <% end %>

          <% else %>
            <%# --- TRƯỜNG HỢP 2: CHƯA ĐĂNG NHẬP --- %>
            <div class="d-flex align-items-center">
              <% unless @course.free? %>
                 <h3 class="text-warning me-3 mb-0">
                   <%= number_to_currency(@course.price, unit: "₫", format: "%n %u", precision: 0) %>
                 </h3>
              <% end %>
              <%= link_to login_path, class: "btn btn-outline-light btn-lg px-4" do %>
                Đăng nhập để đăng ký
              <% end %>
            </div>
          <% end %>
        </div>
        </div>

      <div class="col-md-4 d-none d-md-block">
        <img src="<%= @course.thumbnail_url.presence || 'https://via.placeholder.com/400x300' %>"
             class="img-fluid rounded shadow-lg border border-secondary"
             style="object-fit: cover; width: 100%; height: auto;">
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-lg-8">
      <h3 class="mb-4 border-bottom pb-2">Nội dung khóa học</h3>

      <div class="accordion" id="accordionCourse">
        <% @course.course_modules.order(:order_index).each_with_index do |mod, index| %>
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading<%= mod.id %>">
              <button class="accordion-button <%= 'collapsed' if index > 0 %> fw-bold bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= mod.id %>">
                <%= mod.title %>
              </button>
            </h2>
            <div id="collapse<%= mod.id %>" class="accordion-collapse collapse <%= 'show' if index == 0 %>" data-bs-parent="#accordionCourse">
              <div class="accordion-body p-0">
                <div class="list-group list-group-flush">
                  <% mod.lessons.order(:order_index).each do |lesson| %>
                    <%= link_to lesson_path(lesson), class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3" do %>
                      <span>
                        <i class="bi <%= lesson.video_url.present? ? 'bi-play-circle' : 'bi-file-text' %> me-2 text-muted"></i>
                        <%= lesson.title %>
                      </span>
                      <% if lesson.video_url.present? %>
                        <span class="badge bg-light text-dark border">Video</span>
                      <% end %>
                    <% end %>
                  <% end %>

                  <% if mod.lessons.empty? %>
                     <div class="p-3 text-muted fst-italic small">Nội dung đang được cập nhật.</div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
          <h5 class="card-title fw-bold text-uppercase text-muted small">Giảng viên</h5>
          <div class="d-flex align-items-center mt-3">
             <img src="https://ui-avatars.com/api/?name=<%= @course.creator&.name %>&background=random" class="rounded-circle me-3" width="60">
             <div>
               <h6 class="mb-0 fw-bold"><%= @course.creator&.name || "Admin" %></h6>
               <small class="text-muted">Senior Instructor</small>
             </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0 bg-light">
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> Truy cập trọn đời</li>
            <li class="mb-2"><i class="bi bi-phone-fill text-primary me-2"></i> Học trên thiết bị di động</li>
            <li><i class="bi bi-award-fill text-warning me-2"></i> Cấp chứng chỉ khi hoàn thành</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
